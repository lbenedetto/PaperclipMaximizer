var weights = [0.7783937452622651, -0.14938165477580334, -0.3680841777088212, -1.1252457626179693, -0.2112477139418102, 0.8260575886294412, -0.2990919789916662, -0.0038437508569010848, 0.17947439093936424, 0.3962434422178962, 0.5981559894136005, 0.7398864660009576, -0.5955544842090291, 0.41272631666984694, -0.8958355214595364, -0.6368859309336611, -0.9467058977786209, -0.4964060737901928, -0.4047155531992546, 0.6085881061996055, -1.106000923386581, 1.0682355428786567, 0.2599471670616764, -0.6237321668402183, -0.21064052919732335, 0.6538222536057893, 0.17989867203126647, -0.3136213059092819, 0.555359702986813, 0.3699003805551927, -0.23546988890393816, -0.37395224377078007, -0.6611088600090478, 0.608814556175997, -1.263888451022485, -0.018463040180173813, 0.0315163116526945, 0.8441073578095142, -1.1365308050773744, 0.4929427583314211, -0.5959435636597663, -0.864492282445506, 0.6620523109673373, -0.5204792970201959, -0.3142682507407131, 0.21199125740022537, 0.8802017380511871, -0.95847609140566, 1.1480195559598454, 0.1091958177984731, 0.3943733304334054, 1.0665035176595474, -0.4595147217845176, 0.2407588059980462, -0.9454207028980522, 0.3675767812227524, -0.1320611099986143, 0.08876763709577778, -0.950509905699792, -0.20974538642076368, 0.5083926787830255, 0.5510179322836299, 0.6945284519085739, -0.8100983285756538, -0.6577441872942107, -1.1225175987832308, -0.6260896972480343, 0.3211834162726023, -0.06580069241812336, -0.9830207837856118, 0.5909343792369627, 1.1659997862923794, -0.8403584663940005, -0.024695739553185492, 1.0964496618847372, -0.8491880665949272, 0.6617710252115677, 0.15436862390658898, 0.22059991543150342, 0.23813296177748894, -0.2994304395016749, -0.4918234553849689, 0.3519179811804388, -0.0003009396087233218, 0.4114446239511874, 0.5945298136148087, 0.7587983998189345, 0.9471368643831385, -0.8857557792134654, 0.7843201230508156, -0.7717519698565773, 0.09189775081980991, -0.4365841164660902, 0.16690915319959299, 0.2885465948938822, 1.2178986948336092, 0.7915261830034407, -0.1254669556214547, -0.9226657343217246, -0.1805736537750364, -0.5442241845469813, 0.009082794142639322, -1.1582705624002176, -0.03567709428495956, -0.25886128920383705, 0.5348579999102725, -0.07181673469613761, 0.3027669903246995, -0.8890904826599322, 0.7716191995503818, -0.1708075946257651, -0.8870192626950192, 1.097135429018954, -0.532219188065693, -0.31322131360421646, -0.03105331270328597, -0.3578426356223092, 0.19016359350071976, 0.4026552867900315, 0.2959049986882758, 0.6194669208016548, 0.7314265022094935, -0.533918853910827, -0.6595211408754189, -0.022004309820792933, -0.8881600651004964, 0.3610071499846361, -0.7651966113277777, -0.8890965735259142, 0.7174713713952636, 1.0403365131799476, -0.2378378804063224, -0.8202361959684007, -0.24838041603005784, 0.2074418756609755, -0.04767169552508735, -0.38195781575064663, 0.8485452733921444, -0.664269222893729, 1.097152997355535, -0.9467577085395416, -0.5278334083992253, -0.5599352144809177, 0.20063112034621527, -1.1791348295966424, 0.08404819870962532, 0.49700298674427257, -0.23482234981248373, -0.46160828696194534, -0.7785832936354596, -0.3988115190259949, -0.6981928686276897, -0.478731937569957, -0.7576622020858247, 0.9126924783272785, -0.47485505652126136, -0.2411549520897749, -0.3555806492713127, -0.17211021252394945, 0.9454308948559527, 0.24034751422324446, -0.3976987955132324, -0.8593667066156239, 0.5707956153731388, -0.5841622857170042, 0.841419343377785, 0.38294672033973765, 0.31259648348276386, -0.9843870066312925, 0.38512391945351465, -0.5382572619659487, 0.6708130608659757, 0.6716874754988824, 0.47310504189341945, -0.48701440789587136, 0.11826153076557855, -0.15903966366714545, 0.5132063877879585, -0.7025680705168043, 0.9243850945650287, 0.11837315821418022, -0.6728526288085779, 0.21637537927161477, 1.201729119147823, -0.5795791237030232, -1.1602518351217905, 0.14085348126148994, -0.8090799207363621, -0.899487371779628, -0.047537169400885454, 0.9308500317276974, -0.11475418400717544, 0.939937281624933, -0.8518434214572095, -0.7443072537757776, 0.31710347327000976, 0.496675984680656, 0.6381569464120146, -0.43430049586372854, 0.9995245072580323, 1.127762997255322, -0.8228425827223242, 1.1599095685638838, -1.1023886751029512, 1.0025004854351365, 0.4689389494101899, 0.22730537988331126, -0.5055592623791527, -0.23372177728889304, -0.13008954871945044, 0.15413576302527005, -0.8229056538811615, -0.303376806692923, 0.08290511628745675, 0.6402627011303245, -0.37233180064213445, 0.6181018663957016, 0.01717743665834129, -0.33774368612756467, 0.3840474411141013, -0.2583916301500832, -0.8887299547530194, 0.6815710441917898, 0.4200402683758343, -0.18531178833763165, 0.25583956887461257, -0.10634173649393158, 0.1452901708178007, -0.7188934185466569, 0.589354157223807, -0.7691768343054968, -0.07999068447304816, 0.4470615246519742, 0.7124670730066852, -0.2355822500289233, -0.9127721682527458, -0.03970947369531255, -0.4374990526309075, -0.27044018718576746, 0.6704465759335498, -0.2503523552404706, -1.0396825015887745, -0.11922122809876658, -0.37090364805683435, -0.8134730616683303, -0.3956360945307572, -0.800519823923266, -1.0778811115578364, 0.3750085480977381, 0.2823095853936422, 0.8554384975996696, -0.472062884366739, 0.6929964569023297, 0.3577684432686619, 1.0473391868897248, -0.022780455377610753, 0.012909666362561523, -0.11267177824743083, -0.8233572784918751, 0.7252782788535501, -0.04040722216000514, -0.017705229273158957, 0.06664892066332988, 0.6251091354556744, -1.350261428225775, 0.5906394954595919, -0.5048921570452829, -0.061537012544405606, -0.8363752597244143, 0.49438884193006905, 0.2775630640387741, -0.41390664112177333, -0.020145998075667443, 1.001244929200887, 0.0878749257731122, 0.459947473343323, 0.09932492691798939, -0.188890963260826, -0.8665315116896211, -0.35921049219428874];
var startOps = 5000;
var clickRate = 62;
var network = new Brainwave.Network(13, 7, 20, 13);
network.importWeights(weights);
setTimeout(startGame, 2000);

function startGame() {
	new PaperclipMaximizer(network);
}


function PaperclipMaximizer(net) {
	var ops = startOps;
	var actions, numOutputs;
	var context = $("#game1");
	var game = loadGame();
	var playerBtn = $("#game0").contents().find("#btnMakePaperclip")[0];
	var actionNames = ["Lower Price", "Raise Price", "Expand Marketing", "Buy Wire", "Make Clipper", "Make Mega Clipper"];
	actions = [
		function () {
			game["btnLowerPrice"].click();
		},
		function () {
			game["btnRaisePrice"].click();
		},
		function () {
			game["btnExpandMarketing"].click();
		},
		function () {
			game["btnBuyWire"].click();
		},
		function () {
			game["btnMakeClipper"].click();
		},
		function () {
			game["btnMakeMegaClipper"].click();
		},
		function () {
			//No Op
		}
	];
	numOutputs = actions.length;
	var repeatingTask = setInterval(work, clickRate);

	function work() {
		if (ops <= 0) {//Done with current network
			//TODO: Who won?
			clearInterval(repeatingTask);
		} else {//Run current network
			ops--;
			//Pass game board array into the run function
			var chosenAction = chooseAction(net.run(getGameState()));
			console.log("(" + chosenAction + ") " + actionNames[chosenAction]);
			actions[chosenAction]();
			game["btnMakePaperclip"].click();
			playerBtn.click();
		}
	}

	function chooseAction(output) {
		var max = 0;
		var maxIX = 0;
		for (var i = 0; i < numOutputs; i++) {
			if (output[i] > max) {
				maxIX = i;
				max = output[i];
			}
		}
		return maxIX;
	}

	function loadGame() {
		return {
			"funds": select("#funds"),
			"margin": select("#margin"),//Price per clip
			"clipRate": select("#clipmakerRate"),
			"avgSales": select("#avgSales"),
			"wire": select("#wire"),
			"adCost": select("#adCost"),
			"wireCost": select("#wireCost"),
			"clipperCost": select("#clipperCost"),
			"megaClipperCost": select("#megaClipperCost"),
			//buttons
			"btnMakePaperclip": select("#btnMakePaperclip"),
			"btnLowerPrice": select("#btnLowerPrice"),
			"btnRaisePrice": select("#btnRaisePrice"),
			"btnExpandMarketing": select("#btnExpandMarketing"),
			"btnBuyWire": select("#btnBuyWire"),
			"btnMakeClipper": select("#btnMakeClipper"),
			"btnMakeMegaClipper": select("#btnMakeMegaClipper")
		};
	}

	function getGameState() {
		return [
			toInt(game["funds"]),
			toInt(game["margin"]),//Price per clip
			toInt(game["clipmakerRate"]) - toInt(game["avgSales"]), //Net number of clips per second
			(toInt(game["wire"]) === 0) * 1, //Did we run out of wire?
			toInt(game["adCost"]),
			toInt(game["wireCost"]),
			toInt(game["clipperCost"]),
			toInt(game["megaClipperCost"]),
			//Some booleans for if buttons can be clicked
			game["btnLowerPrice"].disabled * 1,
			game["btnExpandMarketing"].disabled * 1,
			game["btnBuyWire"].disabled * 1,
			game["btnMakeClipper"].disabled * 1,
			game["btnMakeMegaClipper"].disabled * 1
		];
	}

	function select(target) {
		return context.contents().find(target)[0];
	}
}

function toInt(input) {
	try {
		var ht = input.innerHTML;
		var val = parseFloat(ht.replace(/,/g, ''));
		if (isNaN(val)) return 0;
		return val;
	} catch (e) {
		return 0;
	}
}